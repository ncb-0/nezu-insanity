import{O as Ie,a as Z,i as N,b as $,m as ie,o as fe,d as Ot,_ as Mt,e as Rt,f as ye,g as jt,n as Ct,p as ge,h as tt,S as Dt}from"./index.browser.Caqoo78r.js";import{stegaEncodeSourceMap as Lt}from"./stegaEncodeSourceMap.NlBhtwQT.js";import{U as Be}from"./createQueryStore.BWxf6oI1.js";var _=[];for(var ve=0;ve<256;++ve)_.push((ve+256).toString(16).slice(1));function Jt(t,e=0){return(_[t[e+0]]+_[t[e+1]]+_[t[e+2]]+_[t[e+3]]+"-"+_[t[e+4]]+_[t[e+5]]+"-"+_[t[e+6]]+_[t[e+7]]+"-"+_[t[e+8]]+_[t[e+9]]+"-"+_[t[e+10]]+_[t[e+11]]+_[t[e+12]]+_[t[e+13]]+_[t[e+14]]+_[t[e+15]]).toLowerCase()}var ne,Ut=new Uint8Array(16);function Bt(){if(!ne&&(ne=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ne))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ne(Ut)}var zt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const ze={randomUUID:zt};function nt(t,e,n){if(ze.randomUUID&&!e&&!t)return ze.randomUUID();t=t||{};var s=t.random||(t.rng||Bt)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Jt(s)}function Wt(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function Gt(){const t=Wt();if(t.__xstate__)return t.__xstate__}const Pt=t=>{if(typeof window>"u")return;const e=Gt();e&&e.register(t)};class We{constructor(e){this._process=e,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(e){const n={value:e,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const e=this._current;this._process(e.value),this._current=e.next}this._last=null}}const st=".",Kt="",it="",Xt="#",Ht="*",rt="xstate.init",Yt="xstate.error",re="xstate.stop";function Vt(t,e){return{type:`xstate.after.${t}.${e}`}}function be(t,e){return{type:`xstate.done.state.${t}`,output:e}}function Zt(t,e){return{type:`xstate.done.actor.${t}`,output:e,actorId:t}}function ot(t,e){return{type:`xstate.error.actor.${t}`,error:e,actorId:t}}function at(t){return{type:rt,input:t}}function I(t){setTimeout(()=>{throw t})}const Ft=typeof Symbol=="function"&&Symbol.observable||"@@observable";function ct(t,e){const n=Ge(t),s=Ge(e);return typeof s=="string"?typeof n=="string"?s===n:!1:typeof n=="string"?n in s:Object.keys(n).every(i=>i in s?ct(n[i],s[i]):!1)}function Ae(t){if(dt(t))return t;let e=[],n="";for(let s=0;s<t.length;s++){switch(t.charCodeAt(s)){case 92:n+=t[s+1],s++;continue;case 46:e.push(n),n="";continue}n+=t[s]}return e.push(n),e}function Ge(t){if($n(t))return t.value;if(typeof t!="string")return t;const e=Ae(t);return Qt(e)}function Qt(t){if(t.length===1)return t[0];const e={};let n=e;for(let s=0;s<t.length-1;s++)if(s===t.length-2)n[t[s]]=t[s+1];else{const i=n;n={},i[t[s]]=n}return e}function Pe(t,e){const n={},s=Object.keys(t);for(let i=0;i<s.length;i++){const r=s[i];n[r]=e(t[r],r,t,i)}return n}function ut(t){return dt(t)?t:[t]}function A(t){return t===void 0?[]:ut(t)}function xe(t,e,n,s){return typeof t=="function"?t({context:e,event:n,self:s}):t}function dt(t){return Array.isArray(t)}function Nt(t){return t.type.startsWith("xstate.error.actor")}function L(t){return ut(t).map(e=>typeof e>"u"||typeof e=="string"?{target:e}:e)}function ft(t){if(!(t===void 0||t===Kt))return A(t)}function Se(t,e,n){var r,o,a;const s=typeof t=="object",i=s?t:void 0;return{next:(r=s?t.next:t)==null?void 0:r.bind(i),error:(o=s?t.error:e)==null?void 0:o.bind(i),complete:(a=s?t.complete:n)==null?void 0:a.bind(i)}}function Ke(t,e){return`${e}.${t}`}function $e(t,e){const n=e.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return t.implementations.actors[e];const[,s,i]=n,o=t.getStateNodeById(i).config.invoke;return(Array.isArray(o)?o[s]:o).src}function Xe(t,e){return`${t.sessionId}.${e}`}let en=0;function tn(t,e){const n=new Map,s=new Map,i=new WeakMap,r=new Set,o={},{clock:a,logger:c}=e,u={schedule:(f,h,p,y,m=Math.random().toString(36).slice(2))=>{const b={source:f,target:h,event:p,delay:y,id:m,startedAt:Date.now()},g=Xe(f,m);d._snapshot._scheduledEvents[g]=b;const x=a.setTimeout(()=>{delete o[g],delete d._snapshot._scheduledEvents[g],d._relay(f,h,p)},y);o[g]=x},cancel:(f,h)=>{const p=Xe(f,h),y=o[p];delete o[p],delete d._snapshot._scheduledEvents[p],y!==void 0&&a.clearTimeout(y)},cancelAll:f=>{for(const h in d._snapshot._scheduledEvents){const p=d._snapshot._scheduledEvents[h];p.source===f&&u.cancel(f,p.id)}}},l=f=>{if(!r.size)return;const h={...f,rootId:t.sessionId};r.forEach(p=>{var y;return(y=p.next)==null?void 0:y.call(p,h)})},d={_snapshot:{_scheduledEvents:((e==null?void 0:e.snapshot)&&e.snapshot.scheduler)??{}},_bookId:()=>`x:${en++}`,_register:(f,h)=>(n.set(f,h),f),_unregister:f=>{n.delete(f.sessionId);const h=i.get(f);h!==void 0&&(s.delete(h),i.delete(f))},get:f=>s.get(f),_set:(f,h)=>{const p=s.get(f);if(p&&p!==h)throw new Error(`Actor with system ID '${f}' already exists.`);s.set(f,h),i.set(h,f)},inspect:f=>{const h=Se(f);return r.add(h),{unsubscribe(){r.delete(h)}}},_sendInspectionEvent:l,_relay:(f,h,p)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:f,actorRef:h,event:p}),h._send(p)},scheduler:u,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const f=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const h in f){const{source:p,target:y,event:m,delay:b,id:g}=f[h];u.schedule(p,y,m,b,g)}},_clock:a,_logger:c};return d}const qe=1;let S=function(t){return t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped",t}({});const nn={clock:{setTimeout:(t,e)=>setTimeout(t,e),clearTimeout:t=>clearTimeout(t)},logger:console.log.bind(console),devTools:!1};class sn{constructor(e,n){this.logic=e,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new We(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=S.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...nn,...n},{clock:i,logger:r,parent:o,syncSnapshot:a,id:c,systemId:u,inspect:l}=s;this.system=o?o.system:tn(this,{clock:i,logger:r}),l&&!o&&this.system.inspect(Se(l)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=(n==null?void 0:n.logger)??this.system._logger,this.clock=(n==null?void 0:n.clock)??this.system._clock,this._parent=o,this._syncSnapshot=a,this.options=s,this.src=s.src??e,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const f=this.eventListeners.get(d.type),h=this.eventListeners.get("*");if(!f&&!h)return;const p=new Set([...f?f.values():[],...h?h.values():[]]);for(const y of Array.from(p))y(d)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),u&&(this._systemId=u,this.system._set(u,this)),this._initState((n==null?void 0:n.snapshot)??(n==null?void 0:n.state)),u&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(e){var n;try{this._snapshot=e?this.logic.restoreSnapshot?this.logic.restoreSnapshot(e,this._actorScope):e:this.logic.getInitialSnapshot(this._actorScope,(n=this.options)==null?void 0:n.input)}catch(s){this._snapshot={status:"error",output:void 0,error:s}}}update(e,n){var i,r;this._snapshot=e;let s;for(;s=this._deferred.shift();)try{s()}catch(o){this._deferred.length=0,this._snapshot={...e,status:"error",error:o}}switch(this._snapshot.status){case"active":for(const o of this.observers)try{(i=o.next)==null||i.call(o,e)}catch(a){I(a)}break;case"done":for(const o of this.observers)try{(r=o.next)==null||r.call(o,e)}catch(a){I(a)}this._stopProcedure(),this._complete(),this._doneEvent=Zt(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:e})}subscribe(e,n,s){var r;const i=Se(e,n,s);if(this._processingStatus!==S.Stopped)this.observers.add(i);else switch(this._snapshot.status){case"done":try{(r=i.complete)==null||r.call(i)}catch(o){I(o)}break;case"error":{const o=this._snapshot.error;if(!i.error)I(o);else try{i.error(o)}catch(a){I(a)}break}}return{unsubscribe:()=>{this.observers.delete(i)}}}on(e,n){let s=this.eventListeners.get(e);s||(s=new Set,this.eventListeners.set(e,s));const i=n.bind(void 0);return s.add(i),{unsubscribe:()=>{s.delete(i)}}}start(){if(this._processingStatus===S.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=S.Running;const e=at(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:e}),this._snapshot.status){case"done":return this.update(this._snapshot,e),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,e),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(e){let n,s;try{n=this.logic.transition(this._snapshot,e,this._actorScope)}catch(i){s={err:i}}if(s){const{err:i}=s;this._snapshot={...this._snapshot,status:"error",error:i},this._error(i);return}this.update(n,e),e.type===re&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===S.Stopped?this:(this.mailbox.clear(),this._processingStatus===S.NotStarted?(this._processingStatus=S.Stopped,this):(this.mailbox.enqueue({type:re}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){var e;for(const n of this.observers)try{(e=n.complete)==null||e.call(n)}catch(s){I(s)}this.observers.clear()}_reportError(e){if(!this.observers.size){this._parent||I(e);return}let n=!1;for(const s of this.observers){const i=s.error;n||(n=!i);try{i==null||i(e)}catch(r){I(r)}}this.observers.clear(),n&&I(e)}_error(e){this._stopProcedure(),this._reportError(e),this._parent&&this.system._relay(this,this._parent,ot(this.id,e))}_stopProcedure(){return this._processingStatus!==S.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new We(this._process.bind(this)),this._processingStatus=S.Stopped,this.system._unregister(this),this)}_send(e){this._processingStatus!==S.Stopped&&this.mailbox.enqueue(e)}send(e){this.system._relay(void 0,this,e)}attachDevTools(){const{devTools:e}=this.options;e&&(typeof e=="function"?e:Pt)(this)}toJSON(){return{xstate$$type:qe,id:this.id}}getPersistedSnapshot(e){return this.logic.getPersistedSnapshot(this._snapshot,e)}[Ft](){return this}getSnapshot(){return this._snapshot}}function F(t,...[e]){return new sn(t,e)}function rn(t,e,n,s,{sendId:i}){const r=typeof i=="function"?i(n,s):i;return[e,r]}function on(t,e){t.defer(()=>{t.system.scheduler.cancel(t.self,e)})}function lt(t){function e(n,s){}return e.type="xstate.cancel",e.sendId=t,e.resolve=rn,e.execute=on,e}function an(t,e,n,s,{id:i,systemId:r,src:o,input:a,syncSnapshot:c}){const u=typeof o=="string"?$e(e.machine,o):o,l=typeof i=="function"?i(n):i;let d;return u&&(d=F(u,{id:l,src:o,parent:t.self,syncSnapshot:c,systemId:r,input:typeof a=="function"?a({context:e.context,event:n.event,self:t.self}):a})),[C(e,{children:{...e.children,[l]:d}}),{id:i,actorRef:d}]}function cn(t,{id:e,actorRef:n}){n&&t.defer(()=>{n._processingStatus!==S.Stopped&&n.start()})}function ht(...[t,{id:e,systemId:n,input:s,syncSnapshot:i=!1}={}]){function r(o,a){}return r.type="snapshot.spawnChild",r.id=e,r.systemId=n,r.src=t,r.input=s,r.syncSnapshot=i,r.resolve=an,r.execute=cn,r}function un(t,e,n,s,{actorRef:i}){const r=typeof i=="function"?i(n,s):i,o=typeof r=="string"?e.children[r]:r;let a=e.children;return o&&(a={...a},delete a[o.id]),[C(e,{children:a}),o]}function dn(t,e){if(e){if(t.system._unregister(e),e._processingStatus!==S.Running){t.stopChild(e);return}t.defer(()=>{t.stopChild(e)})}}function le(t){function e(n,s){}return e.type="xstate.stopChild",e.actorRef=t,e.resolve=un,e.execute=dn,e}function he(t,e,n,s){const{machine:i}=s,r=typeof t=="function",o=r?t:i.implementations.guards[typeof t=="string"?t:t.type];if(!r&&!o)throw new Error(`Guard '${typeof t=="string"?t:t.type}' is not implemented.'.`);if(typeof o!="function")return he(o,e,n,s);const a={context:e,event:n},c=r||typeof t=="string"?void 0:"params"in t?typeof t.params=="function"?t.params({context:e,event:n}):t.params:void 0;return"check"in o?o.check(s,a,o):o(a,c)}const Oe=t=>t.type==="atomic"||t.type==="final";function z(t){return Object.values(t.states).filter(e=>e.type!=="history")}function ee(t,e){const n=[];if(e===t)return n;let s=t.parent;for(;s&&s!==e;)n.push(s),s=s.parent;return n}function oe(t){const e=new Set(t),n=yt(e);for(const s of e)if(s.type==="compound"&&(!n.get(s)||!n.get(s).length))He(s).forEach(i=>e.add(i));else if(s.type==="parallel"){for(const i of z(s))if(i.type!=="history"&&!e.has(i)){const r=He(i);for(const o of r)e.add(o)}}for(const s of e){let i=s.parent;for(;i;)e.add(i),i=i.parent}return e}function pt(t,e){const n=e.get(t);if(!n)return{};if(t.type==="compound"){const i=n[0];if(i){if(Oe(i))return i.key}else return{}}const s={};for(const i of n)s[i.key]=pt(i,e);return s}function yt(t){const e=new Map;for(const n of t)e.has(n)||e.set(n,[]),n.parent&&(e.has(n.parent)||e.set(n.parent,[]),e.get(n.parent).push(n));return e}function gt(t,e){const n=oe(e);return pt(t,yt(n))}function Me(t,e){return e.type==="compound"?z(e).some(n=>n.type==="final"&&t.has(n)):e.type==="parallel"?z(e).every(n=>Me(t,n)):e.type==="final"}const pe=t=>t[0]===Xt;function fn(t,e){return t.transitions.get(e)||[...t.transitions.keys()].filter(s=>{if(s===Ht)return!0;if(!s.endsWith(".*"))return!1;const i=s.split("."),r=e.split(".");for(let o=0;o<i.length;o++){const a=i[o],c=r[o];if(a==="*")return o===i.length-1;if(a!==c)return!1}return!0}).sort((s,i)=>i.length-s.length).flatMap(s=>t.transitions.get(s))}function ln(t){const e=t.config.after;if(!e)return[];const n=(i,r)=>{const o=Vt(i,t.id),a=o.type;return t.entry.push(X(o,{id:a,delay:i})),t.exit.push(lt(a)),a};return Object.keys(e).flatMap((i,r)=>{const o=e[i],a=typeof o=="string"?{target:o}:o,c=Number.isNaN(+i)?i:+i,u=n(c);return A(a).map(l=>({...l,event:u,delay:c}))}).map(i=>{const{delay:r}=i;return{...R(t,i.event,i),delay:r}})}function R(t,e,n){const s=ft(n.target),i=n.reenter??!1,r=yn(t,s),o={...n,actions:A(n.actions),guard:n.guard,target:r,source:t,reenter:i,eventType:e,toJSON:()=>({...o,source:`#${t.id}`,target:r?r.map(a=>`#${a.id}`):void 0})};return o}function hn(t){const e=new Map;if(t.config.on)for(const n of Object.keys(t.config.on)){if(n===it)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=t.config.on[n];e.set(n,L(s).map(i=>R(t,n,i)))}if(t.config.onDone){const n=`xstate.done.state.${t.id}`;e.set(n,L(t.config.onDone).map(s=>R(t,n,s)))}for(const n of t.invoke){if(n.onDone){const s=`xstate.done.actor.${n.id}`;e.set(s,L(n.onDone).map(i=>R(t,s,i)))}if(n.onError){const s=`xstate.error.actor.${n.id}`;e.set(s,L(n.onError).map(i=>R(t,s,i)))}if(n.onSnapshot){const s=`xstate.snapshot.${n.id}`;e.set(s,L(n.onSnapshot).map(i=>R(t,s,i)))}}for(const n of t.after){let s=e.get(n.eventType);s||(s=[],e.set(n.eventType,s)),s.push(n)}return e}function pn(t,e){const n=typeof e=="string"?t.states[e]:e?t.states[e.target]:void 0;if(!n&&e)throw new Error(`Initial state node "${e}" not found on parent state node #${t.id}`);const s={source:t,actions:!e||typeof e=="string"?[]:A(e.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...s,source:`#${t.id}`,target:n?[`#${n.id}`]:[]})};return s}function yn(t,e){if(e!==void 0)return e.map(n=>{if(typeof n!="string")return n;if(pe(n))return t.machine.getStateNodeById(n);const s=n[0]===st;if(s&&!t.parent)return ae(t,n.slice(1));const i=s?t.key+n:n;if(t.parent)try{return ae(t.parent,i)}catch(r){throw new Error(`Invalid transition definition for state node '${t.id}':
${r.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function vt(t){const e=ft(t.config.target);return e?{target:e.map(n=>typeof n=="string"?ae(t.parent,n):n)}:t.parent.initial}function j(t){return t.type==="history"}function He(t){const e=mt(t);for(const n of e)for(const s of ee(n,t))e.add(s);return e}function mt(t){const e=new Set;function n(s){if(!e.has(s)){if(e.add(s),s.type==="compound")n(s.initial.target[0]);else if(s.type==="parallel")for(const i of z(s))n(i)}}return n(t),e}function W(t,e){if(pe(e))return t.machine.getStateNodeById(e);if(!t.states)throw new Error(`Unable to retrieve child state '${e}' from '${t.id}'; no child states exist.`);const n=t.states[e];if(!n)throw new Error(`Child state '${e}' does not exist on '${t.id}'`);return n}function ae(t,e){if(typeof e=="string"&&pe(e))try{return t.machine.getStateNodeById(e)}catch{}const n=Ae(e).slice();let s=t;for(;n.length;){const i=n.shift();if(!i.length)break;s=W(s,i)}return s}function ce(t,e){if(typeof e=="string"){const i=t.states[e];if(!i)throw new Error(`State '${e}' does not exist on '${t.id}'`);return[t,i]}const n=Object.keys(e),s=n.map(i=>W(t,i)).filter(Boolean);return[t.machine.root,t].concat(s,n.reduce((i,r)=>{const o=W(t,r);if(!o)return i;const a=ce(o,e[r]);return i.concat(a)},[]))}function gn(t,e,n,s){const r=W(t,e).next(n,s);return!r||!r.length?t.next(n,s):r}function vn(t,e,n,s){const i=Object.keys(e),r=W(t,i[0]),o=Re(r,e[i[0]],n,s);return!o||!o.length?t.next(n,s):o}function mn(t,e,n,s){const i=[];for(const r of Object.keys(e)){const o=e[r];if(!o)continue;const a=W(t,r),c=Re(a,o,n,s);c&&i.push(...c)}return i.length?i:t.next(n,s)}function Re(t,e,n,s){return typeof e=="string"?gn(t,e,n,s):Object.keys(e).length===1?vn(t,e,n,s):mn(t,e,n,s)}function _n(t){return Object.keys(t.states).map(e=>t.states[e]).filter(e=>e.type==="history")}function q(t,e){let n=t;for(;n.parent&&n.parent!==e;)n=n.parent;return n.parent===e}function bn(t,e){const n=new Set(t),s=new Set(e);for(const i of n)if(s.has(i))return!0;for(const i of s)if(n.has(i))return!0;return!1}function _t(t,e,n){const s=new Set;for(const i of t){let r=!1;const o=new Set;for(const a of s)if(bn(we([i],e,n),we([a],e,n)))if(q(i.source,a.source))o.add(a);else{r=!0;break}if(!r){for(const a of o)s.delete(a);s.add(i)}}return Array.from(s)}function xn(t){const[e,...n]=t;for(const s of ee(e,void 0))if(n.every(i=>q(i,s)))return s}function je(t,e){if(!t.target)return[];const n=new Set;for(const s of t.target)if(j(s))if(e[s.id])for(const i of e[s.id])n.add(i);else for(const i of je(vt(s),e))n.add(i);else n.add(s);return[...n]}function bt(t,e){const n=je(t,e);if(!n)return;if(!t.reenter&&n.every(i=>i===t.source||q(i,t.source)))return t.source;const s=xn(n.concat(t.source));if(s)return s;if(!t.reenter)return t.source.machine.root}function we(t,e,n){var i;const s=new Set;for(const r of t)if((i=r.target)!=null&&i.length){const o=bt(r,n);r.reenter&&r.source===o&&s.add(o);for(const a of e)q(a,o)&&s.add(a)}return[...s]}function Sn(t,e){if(t.length!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;return!0}function Te(t,e,n,s,i,r){if(!t.length)return e;const o=new Set(e._nodes);let a=e.historyValue;const c=_t(t,o,a);let u=e;i||([u,a]=En(u,s,n,c,o,a,r)),u=G(u,s,n,c.flatMap(d=>d.actions),r),u=Tn(u,s,n,c,o,r,a,i);const l=[...o];u.status==="done"&&(u=G(u,s,n,l.sort((d,f)=>f.order-d.order).flatMap(d=>d.exit),r));try{return a===e.historyValue&&Sn(e._nodes,o)?u:C(u,{_nodes:l,historyValue:a})}catch(d){throw d}}function wn(t,e,n,s,i){if(s.output===void 0)return;const r=be(i.id,i.output!==void 0&&i.parent?xe(i.output,t.context,e,n.self):void 0);return xe(s.output,t.context,r,n.self)}function Tn(t,e,n,s,i,r,o,a){let c=t;const u=new Set,l=new Set;kn(s,o,l,u),a&&l.add(t.machine.root);const d=new Set;for(const f of[...u].sort((h,p)=>h.order-p.order)){i.add(f);const h=[];h.push(...f.entry);for(const p of f.invoke)h.push(ht(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(l.has(f)){const p=f.initial.actions;h.push(...p)}if(c=G(c,e,n,h,r,f.invoke.map(p=>p.id)),f.type==="final"){const p=f.parent;let y=(p==null?void 0:p.type)==="parallel"?p:p==null?void 0:p.parent,m=y||f;for((p==null?void 0:p.type)==="compound"&&r.push(be(p.id,f.output!==void 0?xe(f.output,c.context,e,n.self):void 0));(y==null?void 0:y.type)==="parallel"&&!d.has(y)&&Me(i,y);)d.add(y),r.push(be(y.id)),m=y,y=y.parent;if(y)continue;c=C(c,{status:"done",output:wn(c,e,n,c.machine.root,m)})}}return c}function kn(t,e,n,s){for(const i of t){const r=bt(i,e);for(const a of i.target||[])!j(a)&&(i.source!==a||i.source!==r||i.reenter)&&(s.add(a),n.add(a)),J(a,e,n,s);const o=je(i,e);for(const a of o){const c=ee(a,r);(r==null?void 0:r.type)==="parallel"&&c.push(r),xt(s,e,n,c,!i.source.parent&&i.reenter?void 0:r)}}}function J(t,e,n,s){var i;if(j(t))if(e[t.id]){const r=e[t.id];for(const o of r)s.add(o),J(o,e,n,s);for(const o of r)me(o,t.parent,s,e,n)}else{const r=vt(t);for(const o of r.target)s.add(o),r===((i=t.parent)==null?void 0:i.initial)&&n.add(t.parent),J(o,e,n,s);for(const o of r.target)me(o,t.parent,s,e,n)}else if(t.type==="compound"){const[r]=t.initial.target;j(r)||(s.add(r),n.add(r)),J(r,e,n,s),me(r,t,s,e,n)}else if(t.type==="parallel")for(const r of z(t).filter(o=>!j(o)))[...s].some(o=>q(o,r))||(j(r)||(s.add(r),n.add(r)),J(r,e,n,s))}function xt(t,e,n,s,i){for(const r of s)if((!i||q(r,i))&&t.add(r),r.type==="parallel")for(const o of z(r).filter(a=>!j(a)))[...t].some(a=>q(a,o))||(t.add(o),J(o,e,n,t))}function me(t,e,n,s,i){xt(n,s,i,ee(t,e))}function En(t,e,n,s,i,r,o){let a=t;const c=we(s,i,r);c.sort((l,d)=>d.order-l.order);let u;for(const l of c)for(const d of _n(l)){let f;d.history==="deep"?f=h=>Oe(h)&&q(h,l):f=h=>h.parent===l,u??(u={...r}),u[d.id]=Array.from(i).filter(f)}for(const l of c)a=G(a,e,n,[...l.exit,...l.invoke.map(d=>le(d.id))],o),i.delete(l);return[a,u||r]}let Ye=!1;function St(t,e,n,s,i,r){const{machine:o}=t;let a=t;for(const c of s){let h=function(){n.system._sendInspectionEvent({type:"@xstate.action",actorRef:n.self,action:{type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",params:f}});try{Ye=l,l(d,f)}finally{Ye=!1}};const u=typeof c=="function",l=u?c:o.implementations.actions[typeof c=="string"?c:c.type];if(!l)continue;const d={context:a.context,event:e,self:n.self,system:n.system},f=u||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:e}):c.params:void 0;if(!("resolve"in l)){n.self._processingStatus===S.Running?h():n.defer(()=>{h()});continue}const p=l,[y,m,b]=p.resolve(n,a,d,f,l,i);a=y,"retryResolve"in p&&(r==null||r.push([p,m])),"execute"in p&&(n.self._processingStatus===S.Running?p.execute(n,m):n.defer(p.execute.bind(null,n,m))),b&&(a=St(a,e,n,b,i,r))}return a}function G(t,e,n,s,i,r){const o=r?[]:void 0,a=St(t,e,n,s,{internalQueue:i,deferredActorIds:r},o);return o==null||o.forEach(([c,u])=>{c.retryResolve(n,a,u)}),a}function _e(t,e,n,s=[]){let i=t;const r=[];function o(u,l,d){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:l,snapshot:u,_transitions:d}),r.push(u)}if(e.type===re)return i=C(Ve(i,e,n),{status:"stopped"}),o(i,e,[]),{snapshot:i,microstates:r};let a=e;if(a.type!==rt){const u=a,l=Nt(u),d=Ze(u,i);if(l&&!d.length)return i=C(t,{status:"error",error:u.error}),o(i,u,[]),{snapshot:i,microstates:r};i=Te(d,t,n,a,!1,s),o(i,u,d)}let c=!0;for(;i.status==="active";){let u=c?In(i,a):[];const l=u.length?i:void 0;if(!u.length){if(!s.length)break;a=s.shift(),u=Ze(a,i)}i=Te(u,i,n,a,!1,s),c=i!==l,o(i,a,u)}return i.status!=="active"&&Ve(i,a,n),{snapshot:i,microstates:r}}function Ve(t,e,n){return G(t,e,n,Object.values(t.children).map(s=>le(s)),[])}function Ze(t,e){return e.machine.getTransitionData(e,t)}function In(t,e){const n=new Set,s=t._nodes.filter(Oe);for(const i of s)e:for(const r of[i].concat(ee(i,void 0)))if(r.always){for(const o of r.always)if(o.guard===void 0||he(o.guard,t.context,e,t)){n.add(o);break e}}return _t(Array.from(n),new Set(t._nodes),t.historyValue)}function An(t,e){const n=oe(ce(t,e));return gt(t,[...n])}function $n(t){return!!t&&typeof t=="object"&&"machine"in t&&"value"in t}const qn=function(e){return ct(e,this.value)},On=function(e){return this.tags.has(e)},Mn=function(e){const n=this.machine.getTransitionData(this,e);return!!(n!=null&&n.length)&&n.some(s=>s.target!==void 0||s.actions.length)},Rn=function(){const{_nodes:e,tags:n,machine:s,getMeta:i,toJSON:r,can:o,hasTag:a,matches:c,...u}=this;return{...u,tags:Array.from(n)}},jn=function(){return this._nodes.reduce((e,n)=>(n.meta!==void 0&&(e[n.id]=n.meta),e),{})};function se(t,e){return{status:t.status,output:t.output,error:t.error,machine:e,context:t.context,_nodes:t._nodes,value:gt(e.root,t._nodes),tags:new Set(t._nodes.flatMap(n=>n.tags)),children:t.children,historyValue:t.historyValue||{},matches:qn,hasTag:On,can:Mn,getMeta:jn,toJSON:Rn}}function C(t,e={}){return se({...t,...e},t.machine)}function Cn(t,e){const{_nodes:n,tags:s,machine:i,children:r,context:o,can:a,hasTag:c,matches:u,getMeta:l,toJSON:d,...f}=t,h={};for(const y in r){const m=r[y];h[y]={snapshot:m.getPersistedSnapshot(e),src:m.src,systemId:m._systemId,syncSnapshot:m._syncSnapshot}}return{...f,context:wt(o),children:h}}function wt(t){let e;for(const n in t){const s=t[n];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)e??(e=Array.isArray(t)?t.slice():{...t}),e[n]={xstate$$type:qe,id:s.id};else{const i=wt(s);i!==s&&(e??(e=Array.isArray(t)?t.slice():{...t}),e[n]=i)}}return e??t}function Dn(t,e,n,s,{event:i,id:r,delay:o},{internalQueue:a}){const c=e.machine.implementations.delays;if(typeof i=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${i}" }) instead`);const u=typeof i=="function"?i(n,s):i;let l;if(typeof o=="string"){const d=c&&c[o];l=typeof d=="function"?d(n,s):d}else l=typeof o=="function"?o(n,s):o;return typeof l!="number"&&a.push(u),[e,{event:u,id:r,delay:l}]}function Ln(t,e){const{event:n,delay:s,id:i}=e;if(typeof s=="number"){t.defer(()=>{const r=t.self;t.system.scheduler.schedule(r,r,n,s,i)});return}}function X(t,e){function n(s,i){}return n.type="xstate.raise",n.event=t,n.id=e==null?void 0:e.id,n.delay=e==null?void 0:e.delay,n.resolve=Dn,n.execute=Ln,n}const Fe="xstate.observable.error",Qe="xstate.observable.complete";function Tt(t){return{config:t,transition:(n,s)=>{if(n.status!=="active")return n;switch(s.type){case Fe:return{...n,status:"error",error:s.data,input:void 0,_subscription:void 0};case Qe:return{...n,status:"done",input:void 0,_subscription:void 0};case re:return n._subscription.unsubscribe(),{...n,status:"stopped",input:void 0,_subscription:void 0};default:return n}},getInitialSnapshot:(n,s)=>({status:"active",output:void 0,error:void 0,context:void 0,input:s,_subscription:void 0}),start:(n,{self:s,system:i,emit:r})=>{n.status!=="done"&&(n._subscription=t({input:n.input,system:i,self:s,emit:r}).subscribe({next:o=>{s._parent&&i._relay(s,s._parent,o)},error:o=>{i._relay(s,s,{type:Fe,data:o})},complete:()=>{i._relay(s,s,{type:Qe})}}))},getPersistedSnapshot:({_subscription:n,...s})=>s,restoreSnapshot:n=>({...n,_subscription:void 0})}}function Jn(t,{machine:e,context:n},s,i){const r=(o,a={})=>{const{systemId:c,input:u}=a;if(typeof o=="string"){const l=$e(e,o);if(!l)throw new Error(`Actor logic '${o}' not implemented in machine '${e.id}'`);const d=F(l,{id:a.id,parent:t.self,syncSnapshot:a.syncSnapshot,input:typeof u=="function"?u({context:n,event:s,self:t.self}):u,src:o,systemId:c});return i[d.id]=d,d}else return F(o,{id:a.id,parent:t.self,syncSnapshot:a.syncSnapshot,input:a.input,src:o,systemId:c})};return(o,a)=>{const c=r(o,a);return i[c.id]=c,t.defer(()=>{c._processingStatus!==S.Stopped&&c.start()}),c}}function Un(t,e,n,s,{assignment:i}){if(!e.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const r={},o={context:e.context,event:n.event,spawn:Jn(t,e,n.event,r),self:t.self,system:t.system};let a={};if(typeof i=="function")a=i(o,s);else for(const u of Object.keys(i)){const l=i[u];a[u]=typeof l=="function"?l(o,s):l}const c=Object.assign({},e.context,a);return[C(e,{context:c,children:Object.keys(r).length?{...e.children,...r}:e.children})]}function U(t){function e(n,s){}return e.type="xstate.assign",e.assignment=t,e.resolve=Un,e}function Bn(t,e,n,s,{event:i}){const r=typeof i=="function"?i(n,s):i;return[e,{event:r}]}function zn(t,{event:e}){t.defer(()=>t.emit(e))}function kt(t){function e(n,s){}return e.type="xstate.emit",e.event=t,e.resolve=Bn,e.execute=zn,e}let ke=function(t){return t.Parent="#_parent",t.Internal="#_internal",t}({});function Wn(t,e,n,s,{to:i,event:r,id:o,delay:a},c){var p;const u=e.machine.implementations.delays;if(typeof r=="string")throw new Error(`Only event objects may be used with sendTo; use sendTo({ type: "${r}" }) instead`);const l=typeof r=="function"?r(n,s):r;let d;if(typeof a=="string"){const y=u&&u[a];d=typeof y=="function"?y(n,s):y}else d=typeof a=="function"?a(n,s):a;const f=typeof i=="function"?i(n,s):i;let h;if(typeof f=="string"){if(f===ke.Parent?h=t.self._parent:f===ke.Internal?h=t.self:f.startsWith("#_")?h=e.children[f.slice(2)]:h=(p=c.deferredActorIds)!=null&&p.includes(f)?f:e.children[f],!h)throw new Error(`Unable to send event to actor '${f}' from machine '${e.machine.id}'.`)}else h=f||t.self;return[e,{to:h,event:l,id:o,delay:d}]}function Gn(t,e,n){typeof n.to=="string"&&(n.to=e.children[n.to])}function Pn(t,e){t.defer(()=>{const{to:n,event:s,delay:i,id:r}=e;if(typeof i=="number"){t.system.scheduler.schedule(t.self,n,s,i,r);return}t.system._relay(t.self,n,s.type===Yt?ot(t.self.id,s.data):s)})}function H(t,e,n){function s(i,r){}return s.type="xsnapshot.sendTo",s.to=t,s.event=e,s.id=n==null?void 0:n.id,s.delay=n==null?void 0:n.delay,s.resolve=Wn,s.retryResolve=Gn,s.execute=Pn,s}function Kn(t,e){return H(ke.Parent,t,e)}function Xn(t,e,n,s,{collect:i}){const r=[],o=function(c){r.push(c)};return o.assign=(...a)=>{r.push(U(...a))},o.cancel=(...a)=>{r.push(lt(...a))},o.raise=(...a)=>{r.push(X(...a))},o.sendTo=(...a)=>{r.push(H(...a))},o.sendParent=(...a)=>{r.push(Kn(...a))},o.spawnChild=(...a)=>{r.push(ht(...a))},o.stopChild=(...a)=>{r.push(le(...a))},o.emit=(...a)=>{r.push(kt(...a))},i({context:n.context,event:n.event,enqueue:o,check:a=>he(a,e.context,n.event,e),self:t.self,system:t.system},s),[e,void 0,r]}function P(t){function e(n,s){}return e.type="xstate.enqueueActions",e.collect=t,e.resolve=Xn,e}function k(t,e){const n=A(e);if(!n.includes(t.type)){const s=n.length===1?`type "${n[0]}"`:`one of types "${n.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(t)} to have ${s}`)}}const Ne=new WeakMap;function D(t,e,n){let s=Ne.get(t);return s?e in s||(s[e]=n()):(s={[e]:n()},Ne.set(t,s)),s[e]}const Hn={},K=t=>typeof t=="string"?{type:t}:typeof t=="function"?"resolve"in t?{type:t.type}:{type:t.name}:t;class Ce{constructor(e,n){if(this.config=e,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(st),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?Pe(this.config.states,(s,i)=>new Ce(s,{_parent:this,_key:i,_machine:this.machine})):Hn,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=A(this.config.entry).slice(),this.exit=A(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=A(e.tags).slice()}_initialize(){this.transitions=hn(this),this.config.always&&(this.always=L(this.config.always).map(e=>R(this,it,e))),Object.keys(this.states).forEach(e=>{this.states[e]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(K),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(e=>`#${e.id}`),source:`#${this.id}`,actions:this.initial.actions.map(K),eventType:null})}:void 0,history:this.history,states:Pe(this.states,e=>e.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(e=>({...e,actions:e.actions.map(K)})),entry:this.entry.map(K),exit:this.exit.map(K),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return D(this,"invoke",()=>A(this.config.invoke).map((e,n)=>{const{src:s,systemId:i}=e,r=e.id??Ke(this.id,n),o=typeof s=="string"?s:`xstate.invoke.${Ke(this.id,n)}`;return{...e,src:o,id:r,systemId:i,toJSON(){const{onDone:a,onError:c,...u}=e;return{...u,type:"xstate.invoke",src:o,id:r}}}}))}get on(){return D(this,"on",()=>[...this.transitions].flatMap(([n,s])=>s.map(i=>[n,i])).reduce((n,[s,i])=>(n[s]=n[s]||[],n[s].push(i),n),{}))}get after(){return D(this,"delayedTransitions",()=>ln(this))}get initial(){return D(this,"initial",()=>pn(this,this.config.initial))}next(e,n){const s=n.type,i=[];let r;const o=D(this,`candidates-${s}`,()=>fn(this,s));for(const a of o){const{guard:c}=a,u=e.context;let l=!1;try{l=!c||he(c,u,n,e)}catch(d){const f=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${f?`'${f}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(l){i.push(...a.actions),r=a;break}}return r?[r]:void 0}get events(){return D(this,"events",()=>{const{states:e}=this,n=new Set(this.ownEvents);if(e)for(const s of Object.keys(e)){const i=e[s];if(i.states)for(const r of i.events)n.add(`${r}`)}return Array.from(n)})}get ownEvents(){const e=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(e)}}const Yn="#";class De{constructor(e,n){this.config=e,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=e.id||"(machine)",this.implementations={actors:(n==null?void 0:n.actors)??{},actions:(n==null?void 0:n.actions)??{},delays:(n==null?void 0:n.delays)??{},guards:(n==null?void 0:n.guards)??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new Ce(e,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(e){const{actions:n,guards:s,actors:i,delays:r}=this.implementations;return new De(this.config,{actions:{...n,...e.actions},guards:{...s,...e.guards},actors:{...i,...e.actors},delays:{...r,...e.delays}})}resolveState(e){const n=An(this.root,e.value),s=oe(ce(this.root,n));return se({_nodes:[...s],context:e.context||{},children:{},status:Me(s,this.root)?"done":e.status||"active",output:e.output,error:e.error,historyValue:e.historyValue},this)}transition(e,n,s){return _e(e,n,s).snapshot}microstep(e,n,s){return _e(e,n,s).microstates}getTransitionData(e,n){return Re(this.root,e.value,e,n)||[]}getPreInitialState(e,n,s){const{context:i}=this.config,r=se({context:typeof i!="function"&&i?i:{},_nodes:[this.root],children:{},status:"active"},this);return typeof i=="function"?G(r,n,e,[U(({spawn:a,event:c,self:u})=>i({spawn:a,input:c.input,self:u}))],s):r}getInitialSnapshot(e,n){const s=at(n),i=[],r=this.getPreInitialState(e,s,i),o=Te([{target:[...mt(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],r,e,s,!0,i),{snapshot:a}=_e(o,s,e,i);return a}start(e){Object.values(e.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(e){const n=Ae(e),s=n.slice(1),i=pe(n[0])?n[0].slice(Yn.length):n[0],r=this.idMap.get(i);if(!r)throw new Error(`Child state node '#${i}' does not exist on machine '${this.id}'`);return ae(r,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(e,n){return Cn(e,n)}restoreSnapshot(e,n){const s={},i=e.children;Object.keys(i).forEach(c=>{const u=i[c],l=u.snapshot,d=u.src,f=typeof d=="string"?$e(this,d):d;if(!f)return;const h=F(f,{id:c,parent:n.self,syncSnapshot:u.syncSnapshot,snapshot:l,src:d,systemId:u.systemId});s[c]=h});const r=se({...e,children:s,_nodes:Array.from(oe(ce(this.root,e.value)))},this);let o=new Set;function a(c,u){if(!o.has(c)){o.add(c);for(let l in c){const d=c[l];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===qe){c[l]=u[d.id];continue}a(d,u)}}}}return a(r.context,s),r}}function Vn(t,e){return new De(t,e)}function Et({schemas:t,actors:e,actions:n,guards:s,delays:i}){return{createMachine:r=>Vn({...r,schemas:t},{actors:e,actions:n,guards:s,delays:i})}}var It=new Ie(function(t){return t.complete()});function Zn(t,e,n,s,i,r,o,a){var c=[],u=0,l=0,d=!1,f=function(){d&&!c.length&&!u&&e.complete()},h=function(y){return u<s?p(y):c.push(y)},p=function(y){u++;var m=!1;N(n(y,l++)).subscribe(Z(e,function(b){e.next(b)},function(){m=!0},void 0,function(){if(m)try{u--;for(var b=function(){var g=c.shift();o||p(g)};c.length&&u<s;)b();f()}catch(g){e.error(g)}}))};return t.subscribe(Z(e,h,function(){d=!0,f()})),function(){}}function ue(t,e,n){return n===void 0&&(n=1/0),$(e)?ue(function(s,i){return ie(function(r,o){return e(s,r,i,o)})(N(t(s,i)))},n):(typeof e=="number"&&(n=e),fe(function(s,i){return Zn(s,i,t,n)}))}function Fn(t){return new Ie(function(e){N(t()).subscribe(e)})}var Qn=["addListener","removeListener"],Nn=["addEventListener","removeEventListener"],es=["on","off"];function Q(t,e,n,s){if($(n)&&(s=n,n=void 0),s)return Q(t,e,n).pipe(Ot(s));var i=Mt(ss(t)?Nn.map(function(a){return function(c){return t[a](e,c,n)}}):ts(t)?Qn.map(et(t,e)):ns(t)?es.map(et(t,e)):[],2),r=i[0],o=i[1];if(!r&&Rt(t))return ue(function(a){return Q(a,e,n)})(N(t));if(!r)throw new TypeError("Invalid event target");return new Ie(function(a){var c=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];return a.next(1<u.length?u:u[0])};return r(c),function(){return o(c)}})}function et(t,e){return function(n){return function(s){return t[n](e,s)}}}function ts(t){return $(t.addListener)&&$(t.removeListener)}function ns(t){return $(t.on)&&$(t.off)}function ss(t){return $(t.addEventListener)&&$(t.removeEventListener)}function is(t,e){return e===void 0&&(e=null),e=e??t,fe(function(n,s){var i=[],r=0;n.subscribe(Z(s,function(o){var a,c,u,l,d=null;r++%e===0&&i.push([]);try{for(var f=ye(i),h=f.next();!h.done;h=f.next()){var p=h.value;p.push(o),t<=p.length&&(d=d??[],d.push(p))}}catch(b){a={error:b}}finally{try{h&&!h.done&&(c=f.return)&&c.call(f)}finally{if(a)throw a.error}}if(d)try{for(var y=ye(d),m=y.next();!m.done;m=y.next()){var p=m.value;jt(i,p),s.next(p)}}catch(b){u={error:b}}finally{try{m&&!m.done&&(l=y.return)&&l.call(y)}finally{if(u)throw u.error}}},function(){var o,a;try{for(var c=ye(i),u=c.next();!u.done;u=c.next()){var l=u.value;s.next(l)}}catch(d){o={error:d}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}s.complete()},void 0,function(){i=null}))})}function rs(t,e){return $(e)?ue(t,e,1):ue(t,1)}function Ee(t){return t<=0?function(){return It}:fe(function(e,n){var s=0;e.subscribe(Z(n,function(i){++s<=t&&(n.next(i),t<=s&&n.complete())}))})}function os(t){return fe(function(e,n){N(t).subscribe(Z(n,function(){return n.complete()},Ct)),!n.closed&&e.subscribe(n)})}const M=t=>({context:e})=>{const{count:n,include:s,exclude:i,responseType:r="message.received"}=t;return{count:n,domain:e.domain,from:e.connectTo,include:s?Array.isArray(s)?s:[s]:[],exclude:i?Array.isArray(i)?i:[i]:[],responseType:r,target:e.target,to:e.name}},as=Fn(()=>Q(window,"message")),At=t=>Tt(({input:e})=>{return as.pipe(t?ie(t):ge(),tt((s=>i=>{const{data:r}=i;return(!s.include.length||s.include.includes(r.type))&&(!s.exclude.length||!s.exclude.includes(r.type))&&r.domain===s.domain&&r.from===s.from&&r.to===s.to&&(!s.target||i.source===s.target)})(e)),ie((n=e.responseType,s=>({type:n,message:s}))),e.count?ge(is(e.count),rs(s=>s),Ee(e.count)):ge());var n}),Le="sanity/comlink",B="comlink/response",Y="comlink/heartbeat",V="comlink/disconnect",Je="comlink/handshake/syn",Ue="comlink/handshake/syn-ack",de="comlink/handshake/ack",$t=()=>Et({types:{},actors:{listen:Tt(({input:t})=>{const e=t.signal?Q(t.signal,"abort").pipe((n=`Request ${t.requestId} aborted`,s=>s.pipe(Ee(1),ie(()=>{throw new Error(n)})))):It;var n;return Q(window,"message").pipe(tt(s=>{var i,r;return((i=s.data)==null?void 0:i.type)===B&&((r=s.data)==null?void 0:r.responseTo)===t.requestId&&!!s.source&&t.sources.has(s.source)}),Ee(t.sources.size),os(e))})},actions:{"send message":({context:t},e)=>{const{sources:n,targetOrigin:s}=t,{message:i}=e;n.forEach(r=>{r.postMessage(i,{targetOrigin:s})})},"on success":H(({context:t})=>t.parentRef,({context:t,self:e})=>{var n;return t.response&&((n=t.resolvable)==null||n.resolve(t.response)),{type:"request.success",requestId:e.id,response:t.response,responseTo:t.responseTo}}),"on fail":H(({context:t})=>t.parentRef,({context:t,self:e})=>{var n;return console.warn(`Received no response to message '${t.type}' on client '${t.from}' (ID: '${t.id}').`),(n=t.resolvable)==null||n.reject(new Error("No response received")),{type:"request.failed",requestId:e.id}}),"on abort":H(({context:t})=>t.parentRef,({context:t,self:e})=>{var n;return(n=t.resolvable)==null||n.reject(new Error("Request aborted")),{type:"request.aborted",requestId:e.id}})},guards:{expectsResponse:({context:t})=>t.expectResponse},delays:{initialTimeout:0,responseTimeout:1e4}}).createMachine({context:({input:t})=>({connectionId:t.connectionId,data:t.data,domain:t.domain,expectResponse:t.expectResponse??!1,from:t.from,id:`msg-${nt()}`,parentRef:t.parentRef,resolvable:t.resolvable,response:null,responseTo:t.responseTo,signal:t.signal,sources:t.sources instanceof Set?t.sources:new Set([t.sources]),targetOrigin:t.targetOrigin,to:t.to,type:t.type}),initial:"idle",on:{abort:".aborted"},states:{idle:{after:{initialTimeout:[{target:"sending"}]}},sending:{entry:{type:"send message",params:({context:t})=>{const{connectionId:e,data:n,domain:s,from:i,id:r,responseTo:o,to:a,type:c}=t;return{message:{connectionId:e,data:n,domain:s,from:i,id:r,to:a,type:c,responseTo:o}}}},always:[{guard:"expectsResponse",target:"awaiting"},"success"]},awaiting:{invoke:{id:"listen for response",src:"listen",input:({context:t})=>({requestId:t.id,sources:t.sources,signal:t.signal}),onError:"aborted"},after:{responseTimeout:"failed"},on:{message:{actions:U({response:({event:t})=>t.data.data,responseTo:({event:t})=>t.data.responseTo}),target:"success"}}},failed:{type:"final",entry:"on fail"},success:{type:"final",entry:"on success"},aborted:{type:"final",entry:"on abort"}},output:({context:t,self:e})=>({requestId:e.id,response:t.response,responseTo:t.responseTo})}),qt=()=>Et({types:{},actors:{requestMachine:$t(),listen:At()},actions:{"buffer incoming message":U({handshakeBuffer:({event:t,context:e})=>(k(t,"message.received"),[...e.handshakeBuffer,t])}),"buffer message":P(({enqueue:t})=>{t.assign({buffer:({event:e,context:n})=>(k(e,"post"),[...n.buffer,{data:e.data,resolvable:e.resolvable,signal:e.signal}])}),t.emit(({event:e})=>(k(e,"post"),{type:"_buffer.added",message:e.data}))}),"create request":U({requests:({context:t,event:e,self:n,spawn:s})=>{k(e,"request");const i=(Array.isArray(e.data)?e.data:[e.data]).map(r=>{const o=`req-${nt()}`;return s("requestMachine",{id:o,input:{connectionId:t.connectionId,data:r.data,domain:t.domain,expectResponse:r.expectResponse,from:t.name,parentRef:n,resolvable:r.resolvable,responseTo:r.responseTo,sources:t.target,targetOrigin:t.targetOrigin,to:t.connectTo,type:r.type,signal:r.signal}})});return[...t.requests,...i]}}),"emit heartbeat":kt(()=>({type:"_heartbeat"})),"emit received message":P(({enqueue:t})=>{t.emit(({event:e})=>(k(e,"message.received"),{type:"_message",message:e.message.data})),t.emit(({event:e})=>(k(e,"message.received"),{type:e.message.data.type,message:e.message.data}))}),"flush buffer":P(({enqueue:t})=>{t.raise(({context:e})=>({type:"request",data:e.buffer.map(({data:n,resolvable:s,signal:i})=>({data:n.data,type:n.type,expectResponse:!!s,resolvable:s,signal:i}))})),t.emit(({context:e})=>({type:"_buffer.flushed",messages:e.buffer.map(({data:n})=>n)})),t.assign({buffer:[]})}),"flush handshake buffer":P(({context:t,enqueue:e})=>{t.handshakeBuffer.forEach(n=>e.raise(n)),e.assign({handshakeBuffer:[]})}),post:X(({event:t})=>(k(t,"post"),{type:"request",data:{data:t.data.data,expectResponse:!!t.resolvable,type:t.data.type,resolvable:t.resolvable,signal:t.signal}})),"remove request":P(({context:t,enqueue:e,event:n})=>{k(n,["request.success","request.failed","request.aborted"]),le(n.requestId),e.assign({requests:t.requests.filter(({id:s})=>s!==n.requestId)})}),"send response":X(({event:t})=>(k(t,["message.received","heartbeat.received"]),{type:"request",data:{type:B,responseTo:t.message.data.id,data:void 0}})),"send handshake syn ack":X({type:"request",data:{type:Ue}}),"set connection config":U({connectionId:({event:t})=>(k(t,"message.received"),t.message.data.connectionId),target:({event:t})=>(k(t,"message.received"),t.message.source||void 0),targetOrigin:({event:t})=>(k(t,"message.received"),t.message.origin)})},guards:{hasSource:({context:t})=>t.target!==null}}).createMachine({id:"node",context:({input:t})=>({buffer:[],connectionId:null,connectTo:t.connectTo,domain:t.domain??Le,handshakeBuffer:[],name:t.name,requests:[],target:void 0,targetOrigin:null}),on:{"request.success":{actions:"remove request"},"request.failed":{actions:"remove request"},"request.aborted":{actions:"remove request"}},initial:"idle",states:{idle:{invoke:{id:"listen for handshake syn",src:"listen",input:M({include:Je,count:1}),onDone:{target:"handshaking",guard:"hasSource"}},on:{"message.received":{actions:"set connection config"},post:{actions:"buffer message"}}},handshaking:{entry:"send handshake syn ack",invoke:[{id:"listen for handshake ack",src:"listen",input:M({include:de,count:1,responseType:"handshake.complete"}),onDone:"connected"},{id:"listen for disconnect",src:"listen",input:M({include:V,count:1,responseType:"disconnect"})},{id:"listen for messages",src:"listen",input:M({exclude:[V,de,Y,B]})}],on:{request:{actions:"create request"},post:{actions:"buffer message"},"message.received":{actions:"buffer incoming message"},disconnect:{target:"idle"}}},connected:{entry:["flush handshake buffer","flush buffer"],invoke:[{id:"listen for messages",src:"listen",input:M({exclude:[B,Y]})},{id:"listen for heartbeat",src:"listen",input:M({include:Y,responseType:"heartbeat.received"})},{id:"listen for disconnect",src:"listen",input:M({include:V,count:1,responseType:"disconnect"})}],on:{request:{actions:"create request"},post:{actions:"post"},disconnect:{target:"idle"},"message.received":{actions:["send response","emit received message"]},"heartbeat.received":{actions:["send response","emit heartbeat"]}}}}}),cs=(t,e=qt())=>{const n=F(e,{input:t}),s=()=>{n.stop()};return{actor:n,fetch:(i,r)=>{const o=Promise.withResolvers();return n.send({type:"post",data:i,resolvable:o,signal:r==null?void 0:r.signal}),o.promise},machine:e,on:(i,r)=>{const{unsubscribe:o}=n.on(i,a=>{r(a.message.data)});return o},onStatus:i=>{const r=n.getSnapshot();let o=typeof r.value=="string"?r.value:Object.keys(r.value)[0];const{unsubscribe:a}=n.subscribe(c=>{const u=typeof c.value=="string"?c.value:Object.keys(c.value)[0];o!==u&&(o=u,i(u))});return a},post:i=>{n.send({type:"post",data:i})},start:()=>(n.start(),s),stop:s}},us={"handshake/syn":Je,"handshake/syn-ack":Ue,"handshake/ack":de,"channel/response":B,"channel/heartbeat":Y,"channel/disconnect":V,"overlay/focus":"visual-editing/focus","overlay/navigate":"visual-editing/navigate","overlay/toggle":"visual-editing/toggle","presentation/toggleOverlay":"presentation/toggle-overlay"},ds={[Je]:"handshake/syn",[Ue]:"handshake/syn-ack",[de]:"handshake/ack",[B]:"channel/response",[Y]:"channel/heartbeat",[V]:"channel/disconnect","visual-editing/focus":"overlay/focus","visual-editing/navigate":"overlay/navigate","visual-editing/toggle":"overlay/toggle","presentation/toggle-overlay":"presentation/toggleOverlay"},fs=t=>{const{data:e}=t;return e&&typeof e=="object"&&"domain"in e&&"type"in e&&"from"in e&&"to"in e&&(e.domain==="sanity/channels"&&(e.domain=Le),e.to==="overlays"&&(e.to="visual-editing"),e.from==="overlays"&&(e.from="visual-editing"),e.type=us[e.type]??e.type),t},ls=({context:t},e)=>{const{sources:n,targetOrigin:s}=t,i=((r=e.message).domain===Le&&(r.domain="sanity/channels"),r.to==="visual-editing"&&(r.to="overlays"),r.from==="visual-editing"&&(r.from="overlays"),r.type=ds[r.type]??r.type,r.type==="channel/response"&&r.responseTo&&!r.data&&(r.data={responseTo:r.responseTo}),r);var r;n.forEach(o=>{o.postMessage(i,{targetOrigin:s})})},hs=()=>({listen:At(fs),requestMachine:$t().provide({actions:{"send message":ls}})});function vs(t){const{client:e,setFetcher:n,onConnect:s,onDisconnect:i}=t;if(!(e&&e instanceof Dt))throw new Error(`Expected \`client\` to be an instance of SanityClient or SanityStegaClient: ${JSON.stringify(e)}`);const{projectId:r,dataset:o}=e.config(),a=Be("previewDrafts"),c=Be(!1),u=new Map,l=cs({name:"loaders",connectTo:"presentation"},qt().provide({actors:hs()}));let d;l.onStatus(g=>{g==="connected"?c.set(!0):g==="disconnected"&&c.set(!1)}),l.on("loader/perspective",g=>{if(g.projectId===r&&g.dataset===o){if(g.perspective!=="published"&&g.perspective!=="previewDrafts")throw new Error(`Unsupported perspective: ${JSON.stringify(g.perspective)}`);a.set(g.perspective),m()}}),l.on("loader/query-change",g=>{if(g.projectId===r&&g.dataset===o){const{perspective:x,query:w,params:v}=g;g.result!==void 0&&g.resultSourceMap!==void 0&&e.config().stega.enabled?u.set(JSON.stringify({perspective:x,query:w,params:v}),{...g,result:Lt(g.result,g.resultSourceMap,e.config().stega)}):u.set(JSON.stringify({perspective:x,query:w,params:v}),g),m()}});const f=c.listen(g=>{g?(d=n({hydrate:(x,w,v)=>{const T=(v==null?void 0:v.perspective)||a.get(),O=JSON.stringify({perspective:T,query:x,params:w}),E=u.get(O);return(E==null?void 0:E.result)!==void 0&&(E==null?void 0:E.resultSourceMap)!==void 0?{loading:!1,error:void 0,data:E.result,sourceMap:E.resultSourceMap,perspective:T}:{loading:c.value===!0&&(v==null?void 0:v.data)===void 0||(v==null?void 0:v.sourceMap)===void 0,error:void 0,data:v==null?void 0:v.data,sourceMap:v==null?void 0:v.sourceMap,perspective:(v==null?void 0:v.perspective)||"published"}},fetch:(x,w,v,T)=>{try{const O=p(x,w,v);if(T.signal.addEventListener("abort",()=>{O(),m()},{once:!0}),m(),v.setKey("error",void 0),T.signal.aborted)return}catch(O){v.setKey("error",O),v.setKey("loading",!1)}}}),s==null||s()):(d==null||d(),i==null||i())}),h=new Set,p=(g,x,w)=>{const v={query:g,params:x,$fetch:w};h.add(v),y();const T=setInterval(()=>y(!0),1e3);return()=>{clearInterval(T),h.delete(v),y()}},y=g=>{if(!l)throw new Error("No connection");const x=a.get();for(const{query:w,params:v,$fetch:T}of h)l.post({type:"loader/query-listen",data:{projectId:r,dataset:o,perspective:x,query:w,params:v,heartbeat:1e3}}),!g&&c.value===!0&&T.setKey("loading",!0),T.setKey("perspective",x)};function m(){var w;const g=a.get(),x=[];for(const{query:v,params:T,$fetch:O}of h){const E=JSON.stringify({perspective:g,query:v,params:T}),te=u.get(E);te&&(O.set({data:te.result,error:void 0,loading:!1,perspective:g,sourceMap:te.resultSourceMap}),x.push(...((w=te.resultSourceMap)==null?void 0:w.documents)??[]))}l.post({type:"loader/documents",data:{projectId:r,dataset:o,perspective:g,documents:x}})}const b=l.start();return()=>{d==null||d(),f(),b()}}export{vs as enableLiveMode};
